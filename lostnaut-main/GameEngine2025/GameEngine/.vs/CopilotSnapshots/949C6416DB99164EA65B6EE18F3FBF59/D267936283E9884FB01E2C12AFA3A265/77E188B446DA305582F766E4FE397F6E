#pragma once
#include <glm.hpp>
#include <gtc/matrix_transform.hpp>
#include <vector>
#include <algorithm>
#include <cstdio>

// Interface for any object that can participate in collision detection
class ICollidable
{
public:
    virtual ~ICollidable() = default;
    
    // Get the world-space axis-aligned bounding box
    virtual void getWorldAABB(glm::vec3& outMin, glm::vec3& outMax) const = 0;
        
    // Optional: check if collision is enabled for this object
    virtual bool isCollisionEnabled() const { return true; }
};

// Centralized collision manager that handles collision detection and resolution
class CollisionManager
{
public:
    enum class ContactFace { None, Top, Bottom, Left, Right, Front, Back };

    CollisionManager();
    ~CollisionManager();

    // Register a collidable object with the manager
    void addCollidable(ICollidable* collidable);
    
    // Remove a collidable object from the manager
    void removeCollidable(ICollidable* collidable);
    
    // Clear all registered collidables
    void clearAll();

    // Resolve a point against ALL registered collidables
    // Returns true if any collision was resolved
    bool resolvePointAgainstAll(glm::vec3& point, float eyeHeight);

    // Resolve a point against a single collidable object
    // Returns true if collision was resolved
    bool resolvePoint(const ICollidable* collidable, glm::vec3& point, float eyeHeight);

    // Get detailed contact information for debugging
    bool getContactInfo(const ICollidable* collidable, const glm::vec3& point, float eyeHeight,
                        glm::vec3& outPushDirection, ContactFace& outFace) const;

    // Check if a point is inside a collidable's AABB
    bool isPointInsideAABB(const ICollidable* collidable, const glm::vec3& point) const;

    // Set collision margin (small buffer to prevent clipping)
    void setCollisionMargin(float margin) { collisionMargin = margin; }
    float getCollisionMargin() const { return collisionMargin; }

    // Enable/disable debug output
    void setDebugOutput(bool enabled) { debugOutput = enabled; }

private:
    std::vector<ICollidable*> collidables;
    float collisionMargin;
    bool debugOutput;

    // Internal helper to resolve point against an AABB
    bool resolvePointAgainstAABB(const glm::vec3& minW, const glm::vec3& maxW, 
                                  glm::vec3& point, float eyeHeight, ContactFace& outFace);
};